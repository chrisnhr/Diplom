WITH cte_grouped AS (
  SELECT
    TEST_ITEM_COMMUNICATIONKEY,
    COUNT(*) AS TOTAL_LENGTH
  FROM `brain-flash-dev.dagster_common.CN_data_to_fetch`
  WHERE TEST_ITEM_COMMUNICATIONKEY = TWIN_ITEM_COMMUNICATIONKEY
  GROUP BY TEST_ITEM_COMMUNICATIONKEY
),
cte_total_items AS (
  SELECT
    COUNT(DISTINCT TEST_ITEM_COMMUNICATIONKEY) AS TOTAL_ITEMS
  FROM cte_grouped
),
cte_sum_lengths AS (
  SELECT
    SUM(TOTAL_LENGTH) AS SUM_TOTAL_LENGTHS
  FROM cte_grouped
)
SELECT 
  SUM_TOTAL_LENGTHS / NULLIF(TOTAL_ITEMS, 0) AS AVERAGE_TOTAL_LENGTH
FROM cte_sum_lengths, cte_total_items
