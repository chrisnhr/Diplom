-- Analyse der filled Ansprache_Unbiased

WITH cte_foo AS(
SELECT ITEMOPTION_COMMUNICATIONKEY,
  SUM(ARRAY_LENGTH(cleaned_deal_list)) MARKETING
FROM `brain-flash-dev.dagster_common.CN_datamart_dynamic_slice`
GROUP BY ITEMOPTION_COMMUNICATIONKEY
HAVING MARKETING > 0
ORDER BY MARKETING
LIMIT 10
)
SELECT 
  ITEMOPTION_COMMUNICATIONKEY,
  CALENDAR_DATE,
  ANSPRACHE,
  LAST_VALUE(ANSPRACHE_UNBIASED IGNORE NULLS) OVER (ORDER BY dyn.CALENDAR_DATE ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ANSPRACHE_IMPUTED_FFILL
FROM `brain-flash-dev.dagster_common.CN_datamart_dynamic_slice` dyn
JOIN cte_foo
USING(ITEMOPTION_COMMUNICATIONKEY)
ORDER BY ITEMOPTION_COMMUNICATIONKEY

-- Analyse der filled Ansprache_Unbiased
WITH cte_foo AS(
SELECT DISTINCT ITEMOPTION_COMMUNICATIONKEY
FROM `brain-flash-dev.dagster_common.CN_datamart_dynamic_slice`
WHERE "ddm" IN UNNEST(cleaned_deal_list)
)

SELECT ITEMOPTION_COMMUNICATIONKEY,
CALENDAR_DATE,
ANSPRACHE,
ANSPRACHE_UNBIASED,
CASE WHEN ANSPRACHE_UNBIASED IS NULL THEN CAST(ROUND(AVG_ANSPRACHE_UNBIASED_AVLBL_OTTO_DE_365) AS INT64) ELSE ANSPRACHE_UNBIASED END AS ANSPRACHE_UNBIASED_FILL
FROM `brain-flash-dev.dagster_common.CN_datamart_dynamic_slice`
JOIN cte_foo
  USING(ITEMOPTION_COMMUNICATIONKEY)
  WHERE ITEMOPTION_COMMUNICATIONKEY = 1637109488
ORDER BY ITEMOPTION_COMMUNICATIONKEY, CALENDAR_DATE